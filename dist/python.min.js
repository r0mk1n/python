/** pythonApp (c) twitter@r0mk1n, 2016 */
var r0mk1n={};r0mk1n.scenes={},r0mk1n.Consts={cell_x_count:80,cell_y_count:60,environment_percent:3,canvasId:"r0mk1n_pythonApp",storageKey:"r0mk1n.pythonApp",audioUrl:"http://89.184.1.39:8050/;",palettes:[{low:"#747274",med:"#bcbabc",high:"#fcfafc"},{low:"#844204",med:"#ec9a54",high:"#fcfafc"},{low:"#ac2624",med:"#ec8a8c",high:"#fcfafc"},{low:"#947a4c",med:"#c4ae94",high:"#fceae4"},{low:"#0432fc",med:"#7caafc",high:"#fcfafc"},{low:"#4432a4",med:"#9c92f4",high:"#fcfafc"}],intro:{title:{font:"48px Tahoma, Geneva, sans-serif",text:"-==python==:)"},subtitle:{font:"12px Tahoma, Geneva, sans-serif",text:"VanillaJS/CanvasAPI/LocalStorageAPI/AudioAPI ^-^ twitter@r0mk1n 2016"},press:{text:"press SPACE to play",font:"16px Tahoma, Geneva, sans-serif"},bottom:{font:"12px Tahoma, Geneva, sans-serif",text:"ANYWHERE: 1-2 cycle theme, M - toggle music | IN GAME: WASD or cursor keys - move, SPACE - pause"},blinkTimeout:400},game:{pause:{font:"48px Tahoma, Geneva, sans-serif",text:"-=paused=-"},pause_sub:{font:"12px Tahoma, Geneva, sans-serif",text:"press SPACE to resume"},game_over:{font:"48px Tahoma, Geneva, sans-serif",text:"-=game over=-"},game_over_sub:{font:"12px Tahoma, Geneva, sans-serif",text:"press SPACE to restart"},score:{font:"14px Tahoma, Geneva, sans-serif",text:"SCORE:"}},default_food_count:10,default_game_speed:200,speed_dy_length:[{max_length:1,speed:200},{max_length:5,speed:180},{max_length:10,speed:170},{max_length:20,speed:160},{max_length:30,speed:140},{max_length:50,speed:120},{max_length:100,speed:100},{max_length:150,speed:90},{max_length:200,speed:80},{max_length:400,speed:70},{max_length:600,speed:60},{max_length:1e3,speed:50},{max_length:2e3,speed:40},{max_length:3e3,speed:30},{max_length:4e3,speed:20},{max_length:1e5,speed:10}],score_points_per_food:5,hideAction:"blur(5px) sepia(50%)"},r0mk1n.Settings=function(a){var b=null,c=null,d=null,e={};this.set=function(a,b){e[a]=b,h()},this.get=function(a){return"undefined"!=typeof e[a]?e[a]:null},this.clean=function(){d&&d.removeItem(c)};var f=function(a){b=a.consts,c=b.storageKey,d=window.localStorage,g()},g=function(){d&&(e=JSON.parse(d.getItem(c))||{})},h=function(){d&&d.setItem(c,JSON.stringify(e))};f(a)},r0mk1n.Palette=function(a){var b=this;this.low=null,this.med=null,this.high=null;var c=null,d=null,e=0;this.next=function(){e<c.palettes.length?e++:e=0,this.setIndex(e)},this.prev=function(){e>0?e--:e=c.palettes.length-1,this.setIndex(e)},this.setIndex=function(a){e="undefined"!=typeof a&&a>=0&&a<=c.palettes.length-1?a:0,d.set("currentPaletteIndex",e),b.low=c.palettes[e].low,b.med=c.palettes[e].med,b.high=c.palettes[e].high},this.getIndex=function(){return e};var f=function(a){c=a.consts,d=a.settings,e=d.get("currentPaletteIndex")||0,b.setIndex(e)};f(a)},r0mk1n.Music=function(a){var b=null,c=null,d=!1,e=null;this.toggle=function(){d=!d,e.set("is_music_muted",d),d?b.pause():b.play()};var f=function(a){c=a.stream,e=a.settings,b=document.createElement("audio");document.getElementsByTagName("body")[0].appendChild(b);b.src=c,d=e.get("is_music_muted")?!0:!1,d||b.play()};f(a)},r0mk1n.scenes.IntroScene=function(a){var b=null,c=null,d=null,e=!1,f=-1;this.show=function(a){e=!0,g(),this.redraw()},this.hide=function(a){e=!1,clearInterval(f)},this.redraw=function(){b.fillStyle=c.low,b.fillRect(0,0,b.canvas.width,b.canvas.height),b.font=d.intro.title.font;var a=b.measureText(d.intro.title.text);b.fillStyle=c.high,b.fillText(d.intro.title.text,49,b.canvas.height/2-11),b.fillStyle=c.low,b.fillText(d.intro.title.text,51,b.canvas.height/2-9),b.fillStyle=c.med,b.fillText(d.intro.title.text,50,b.canvas.height/2-10),b.strokeStyle=c.med,b.lineWidth=1,b.setLineDash([1,2]),b.moveTo(50,b.canvas.height/2+5),b.lineTo(b.canvas.width-50,b.canvas.height/2+5),b.stroke(),b.fillStyle=c.med,b.font=d.intro.subtitle.font,a=b.measureText(d.intro.subtitle.text),b.fillText(d.intro.subtitle.text,b.canvas.width-(a.width+50),b.canvas.height/2+20),b.fillStyle=c.med,b.font=d.intro.bottom.font,a=b.measureText(d.intro.bottom.text),b.fillText(d.intro.bottom.text,b.canvas.width/2-a.width/2,b.canvas.height-15),b.font=d.intro.press.font,a=b.measureText(d.intro.press.text),f&&clearInterval(f);var g=!0;f=setInterval(function(){e?(g?(b.fillStyle=c.high,b.fillText(d.intro.press.text,b.canvas.width/2-a.width/2,b.canvas.height-100)):(b.fillStyle=c.low,b.fillRect(0,b.canvas.height-150,b.canvas.width,100)),g=!g):clearInterval(f)},d.intro.blinkTimeout)};var g=function(){b.clearRect(0,0,b.canvas.width,b.canvas.height)},h=function(a){b=a.ctx,c=a.palette,d=a.consts};h(a)},r0mk1n.scenes.GameScene=function(a){var b=this,c=null,d=null,e=null,f=!1,g=!1,h="l",i=[],j=[],k=0,l=-1,m=400,n=-1,o=0,p=0,q=0,r=0,s=2*Math.PI,t=!1,u=0,v=[];this.show=function(a){J(),E(),f=!0,F();var c=Math.floor(1e3/30);-1!=l&&clearInterval(l),-1!=l&&clearInterval(l),l=setInterval(function(){b.redraw()},c),n=setTimeout(function(){w()},m),"undefined"!=typeof a&&a()},this.hide=function(a){f=!1,"undefined"!=typeof a&&a()},this.redraw=function(a){var b;if(c.fillStyle=d.low,c.fillRect(0,0,c.canvas.width,c.canvas.height),g&&(x(e.game.pause),y(e.game.pause_sub,c.canvas.height/2+30)),t&&(x(e.game.game_over),y(e.game.game_over_sub,c.canvas.height/2+30)),!g&&!t||a){for(G(),b=0;b<i.length;b++)c.fillStyle=d.med,c.fillRect(i[b].x*o,i[b].y*p,o,p),0===b&&(-1!=["l","r"].indexOf(h)?(c.beginPath(),c.fillStyle=d.low,c.ellipse(i[b].x*o+q,i[b].y*p+r/2,q/4,r/4,0,0,s),c.ellipse(i[b].x*o+q,i[b].y*p+r+r/2,q/4,r/4,0,0,s),c.fill()):(c.beginPath(),c.fillStyle=d.low,c.ellipse(i[b].x*o+q/2,i[b].y*p+r,q/4,r/4,0,0,s),c.ellipse(i[b].x*o+q+q/2,i[b].y*p+r,q/4,r/4,0,0,s),c.fill()));for(b=0;b<j.length;b++)c.beginPath(),c.fillStyle=d.high,c.ellipse(j[b].x*o+q,j[b].y*p+1.6*r,q,r/2,0,0,s),c.fill(),c.beginPath(),c.ellipse(j[b].x*o+q-q/2,j[b].y*p+r-r/4,q/3,r/1.4,-10,0,s),c.fill(),c.beginPath(),c.ellipse(j[b].x*o+q+q/2,j[b].y*p+r-r/4,q/3,r/1.4,10,0,s),c.fill(),c.fillStyle=d.low,c.beginPath(),c.ellipse(j[b].x*o+q-q/2.4,j[b].y*p+r+r/1.5,q/4,r/4,0,0,s),c.fill(),c.beginPath(),c.ellipse(j[b].x*o+q+q/2.4,j[b].y*p+r+r/1.5,q/4,r/4,0,0,s),c.fill();var f={text:e.game.score.text+" "+u.toString(),font:e.game.score.font};y(f,20),y(e.intro.bottom,c.canvas.height-15)}},this.togglePause=function(){t?this.show():g=!g},this.setDirection=function(a){("l"==h&&"r"!=a||"r"==h&&"l"!=a||"u"==h&&"d"!=a||"d"==h&&"u"!=a)&&(h=a)};var w=function(){if(!g&&!t){var a={x:i[0].x,y:i[0].y};switch(h){case"l":a.x--;break;case"r":a.x++;break;case"u":a.y--;break;case"d":a.y++}if(a.x<0||a.x>e.cell_x_count||a.y<0||a.y>e.cell_y_count)return void(t=!0);if(-1!=C(a))return void(t=!0);var b=B(a);if(-1==b){for(var c=i.length-1;c>0;c--)i[c].x=i[c-1].x,i[c].y=i[c-1].y;i[0].x=a.x,i[0].y=a.y}else i.unshift({x:j[b].x,y:j[b].y}),j.splice(b,1),u+=e.score_points_per_food;A()}z(),n=setTimeout(function(){w()},m)},x=function(a){c.font=a.font;var b=c.measureText(a.text),e=c.canvas.width/2-b.width/2;c.fillStyle=d.high,c.fillText(a.text,e-1,c.canvas.height/2-11),c.fillStyle=d.low,c.fillText(a.text,e+1,c.canvas.height/2-9),c.fillStyle=d.med,c.fillText(a.text,e,c.canvas.height/2-10)},y=function(a,b){c.fillStyle=d.high,c.font=a.font;var e=c.measureText(a.text);c.fillText(a.text,c.canvas.width/2-e.width/2,b)},z=function(){for(var a=m,b=i.length,c=0;c<e.speed_dy_length.length;c++)b>=e.speed_dy_length[c].max_length&&(a=e.speed_dy_length[c].speed);m=a},A=function(){for(var a,b=k-j.length,c=0;b>c;c++){do a={x:D(0,e.cell_x_count),y:D(0,e.cell_y_count)};while(-1!=B(a)&&-1!=C(a));j.push(a)}},B=function(a){for(var b=-1,c=0;c<j.length;c++)if(j[c].x==a.x&&j[c].y==a.y){b=c;break}return b},C=function(a){for(var b=-1,c=0;c<i.length;c++)if(i[c].x==a.x&&i[c].y==a.y){b=c;break}return b},D=function(a,b){return Math.floor(Math.random()*(b-a+1))+a},E=function(){var a=Math.round(e.cell_x_count/2),b=Math.round(e.cell_y_count/2);i=[{x:a,y:b},{x:a-1,y:b}],h="r",j=[],k=e.default_food_count,m=e.default_game_speed,t=!1,u=0},F=function(){v=[];for(var a=e.cell_x_count*e.cell_y_count*e.environment_percent/100,b=0;a>b;b++)v.push({x:D(0,e.cell_x_count),y:D(5,e.cell_y_count-5),color:D(1,2),type:D(0,1)})},G=function(){c.setLineDash([]);for(var a=0;a<v.length;a++){switch(v[a].color){case 1:c.strokeStyle=d.med;break;case 2:c.strokeStyle=d.high}switch(c.beginPath(),v[a].type){case 0:H(v[a].x*o,v[a].y*p);break;case 1:I(v[a].x*o,v[a].y*p)}c.stroke()}},H=function(a,b){c.moveTo(a+q,b+p),c.lineTo(a+q-D(0,1),b+r-D(0,2)),c.moveTo(a+q,b+p),c.lineTo(a+q-D(2,3),b+r-D(0,2)),c.moveTo(a+q,b+p),c.lineTo(a+q+D(2,3),b+r-D(0,1))},I=function(a,b){c.moveTo(a+q,b+p),c.lineTo(a+q-D(0,1),b+r-D(1,2)),c.moveTo(a+q,b+p),c.lineTo(a+q-D(1,2),b+r-D(1,2)),c.moveTo(a+q,b+p),c.lineTo(a+q+D(3,4),b+r-D(1,2))},J=function(){c.clearRect(0,0,c.canvas.width,c.canvas.height)},K=function(a){c=a.ctx,d=a.palette,e=a.consts,o=c.canvas.width/e.cell_x_count,p=c.canvas.height/e.cell_y_count,q=o/2,r=p/2};K(a)},r0mk1n.PythonApp=function(a){var b=r0mk1n.Consts,c=new r0mk1n.Settings({consts:b}),d=null,e=null,f=null,g={},h="intro",i=null,j=null,k=function(a){if(e="undefined"!=typeof a.placeholder?document.getElementById(a.placeholder):document.getElementsByTagName("body")[0],m()){var h=document.createElement("canvas");e.appendChild(h),h.width=parseInt(e.style.width),h.height=parseInt(e.style.height),f=h.getContext("2d"),j=new r0mk1n.Music({stream:b.audioUrl,settings:c}),d=new r0mk1n.Palette({consts:b,settings:c}),g.intro=new r0mk1n.scenes.IntroScene({consts:b,palette:d,ctx:f}),g.game=new r0mk1n.scenes.GameScene({consts:b,palette:d,ctx:f}),i=g.intro,i.show(),window.onkeydown=l}else alert("Sorry, this app working in modern browsers only.")},l=function(a){49==a.keyCode&&(d.prev(),i.redraw(!0)),50==a.keyCode&&(d.next(),i.redraw(!0)),77==a.keyCode&&j.toggle(),32==a.keyCode&&("intro"==h?(i.hide(),i=g.game,setTimeout(function(){i.show(),h="game"},500)):"game"==h&&i.togglePause(),a.preventDefault()),"game"==h&&(-1!=[87,38].indexOf(a.keyCode)&&i.setDirection("u"),-1!=[83,40].indexOf(a.keyCode)&&i.setDirection("d"),-1!=[65,37].indexOf(a.keyCode)&&i.setDirection("l"),-1!=[68,39].indexOf(a.keyCode)&&i.setDirection("r"),-1!=[37,38,39,49].indexOf(a.keyCode)&&a.preventDefault())},m=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))};k(a)};